0x52

medium

# Collateral cannot be withdrawn if it can't be priced even if the position has no outstanding debt

## Summary

Collateral cannot be withdrawn if it can't be adequately priced by an oracle. This includes withdrawals for an account with no debt

## Vulnerability Detail

## Impact

## Code Snippet

## Tool used

Manual Review

## Recommendation

Shortcircuit getPositionRisk to return 0 if the position has no debt. This avoids the scenario where the underlying collateral can't be priced because the entire valuation is bypassed. It is safe because if there is no debt at all then by definition there's no possible liquidation:

        Position storage pos = positions[positionId];
    +   uint256 ov = getDebtValue(positionId);
    +   if (ov == 0) return 0;
        uint256 pv = getPositionValue(positionId);
    -   uint256 ov = getDebtValue(positionId);
        uint256 cv = oracle.getUnderlyingValue(
            pos.underlyingToken,
            pos.underlyingAmount
        );

        if (cv == 0) risk = 0;
        else if (pv >= ov) risk = 0;
        else {
            risk = ((ov - pv) * DENOMINATOR) / cv;
        }