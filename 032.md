0x52

high

# IchiVaultSpell#openPositionFarm can cause Ichi to be harvested but doesn't send it to the user

## Summary

When openPositionFarm is called and the user already has a farm position, the original position will be removed and then all the LP will be restaked. The problem is that the WIchiFarm#burn will result in the IchiTokens being harvested and sent to IchiVaultSpell. It should transfer these harvested tokens to the user but instead they aren't resulting in loss of funds for the user.

## Vulnerability Detail

## Impact

User will have their Ichi rewards stolen

## Code Snippet

## Tool used

Manual Review

## Recommendation

Refund Ichi at the end of the withdraw block in openPositionFarm:

        if (collSize > 0) {
            (uint256 decodedPid, ) = wIchiFarm.decodeId(collId);
            if (farmingPid != decodedPid) revert INCORRECT_PID(farmingPid);
            if (posCollToken != address(wIchiFarm))
                revert INCORRECT_COLTOKEN(posCollToken);
            bank.takeCollateral(collSize);
            wIchiFarm.burn(collId, collSize);
    +       doCutRewardsFee(ICHI);
        }